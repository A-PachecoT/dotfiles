#!/bin/bash
# Interactive picker for pending Claude events
# Usage: claude-picker
# Opens fzf in tmux popup to select and jump to pending Claude

set -euo pipefail

QUEUE_DIR="$HOME/.claude-pending"
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"

mkdir -p "$QUEUE_DIR"

# Check if any pending
COUNT=$(find "$QUEUE_DIR" -type f -name '*_*_*_*' 2>/dev/null | wc -l | tr -d ' ')
if [[ "$COUNT" -eq 0 ]]; then
    # No pending - show notification
    if [[ -n "${TMUX:-}" ]]; then
        tmux display-message "No pending Claude events"
    else
        # Use osascript for notification when outside terminal
        osascript -e 'display notification "No pending Claude events" with title "Claude"' 2>/dev/null || true
    fi
    exit 0
fi

# Build the picker command
PICKER_CMD="$SCRIPT_DIR/claude-picker-fzf"

# Clean up any stale target file
rm -f /tmp/claude-picker-target

# If inside tmux, use popup
if [[ -n "${TMUX:-}" ]]; then
    tmux display-popup -E -w 60% -h 50% "$PICKER_CMD"
else
    # Outside tmux (called from AeroSpace)
    # Send popup command to first available tmux session
    if tmux list-sessions &>/dev/null; then
        FIRST_SESSION=$(tmux list-sessions -F '#S' | head -1)
        # Run popup in that session (don't attach, just send command)
        tmux display-popup -t "$FIRST_SESSION" -E -w 60% -h 50% "$PICKER_CMD"
    else
        # No tmux sessions - show notification
        osascript -e 'display notification "No tmux sessions available" with title "Claude Picker"' 2>/dev/null || true
        exit 0
    fi
fi

# Wait for popup to write target file (may take a moment)
for i in {1..50}; do
    [[ -f /tmp/claude-picker-target ]] && break
    sleep 0.1
done

# After popup closes, navigate to selected target
# Format: session:window_index:workspace:queue_file_path
if [[ -f /tmp/claude-picker-target ]]; then
    TARGET=$(cat /tmp/claude-picker-target)
    SESSION=$(echo "$TARGET" | cut -d: -f1)
    WINDOW_INDEX=$(echo "$TARGET" | cut -d: -f2)
    WORKSPACE=$(echo "$TARGET" | cut -d: -f3)
    QUEUE_FILE=$(echo "$TARGET" | cut -d: -f4-)

    # Switch AeroSpace workspace FIRST (must happen before tmux navigation)
    if [[ -n "$WORKSPACE" ]]; then
        CURRENT_WS=$(aerospace list-workspaces --focused 2>/dev/null || echo "")
        if [[ "$CURRENT_WS" != "$WORKSPACE" ]]; then
            aerospace workspace "$WORKSPACE" 2>/dev/null || true
            sleep 0.2  # Give AeroSpace time to focus the workspace
        fi
    fi

    # Navigate tmux using window index
    if [[ -n "${TMUX:-}" ]]; then
        tmux switch-client -t "${SESSION}:${WINDOW_INDEX}" 2>/dev/null || \
        tmux switch-client -t "$SESSION" 2>/dev/null || true
    else
        tmux select-window -t "${SESSION}:${WINDOW_INDEX}" 2>/dev/null || true
    fi

    # Clear the pending queue file we just navigated to
    if [[ -n "$QUEUE_FILE" && -f "$QUEUE_FILE" ]]; then
        rm -f "$QUEUE_FILE" 2>/dev/null || true
    fi

    # Trigger SketchyBar refresh
    sketchybar --trigger claude_pending_change 2>/dev/null &

    rm -f /tmp/claude-picker-target
fi
