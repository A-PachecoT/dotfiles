#!/bin/bash
# Claude Code notification with voice announcement and queue management
# Usage: claude-notify <event_type>
#   event_type: "stop" or "question"
#
# IMPORTANT: This runs as a Claude Code hook - must NOT block or hang.
# All external commands use timeouts and run detached from the script.

# Don't use set -e (exit on error) - we want to continue even if commands fail
set +e

QUEUE_DIR="$HOME/.claude-pending"
EVENT_TYPE="${1:-stop}"
TIMESTAMP=$(date +%s)

# Ensure queue directory exists
mkdir -p "$QUEUE_DIR" 2>/dev/null || true

# Get tmux context (if in tmux) - with timeout
if [[ -n "${TMUX:-}" ]]; then
    SESSION=$(timeout 1 tmux display-message -p '#S' 2>/dev/null) || SESSION="unknown"
    WINDOW=$(timeout 1 tmux display-message -p '#W' 2>/dev/null) || WINDOW="unknown"
    WINDOW_INDEX=$(timeout 1 tmux display-message -p '#I' 2>/dev/null) || WINDOW_INDEX="0"
    PANE_ID=$(timeout 1 tmux display-message -p '#D' 2>/dev/null) || PANE_ID="0"
else
    SESSION="standalone"
    WINDOW=$(basename "$PWD" 2>/dev/null) || WINDOW="unknown"
    WINDOW_INDEX="0"
    PANE_ID="0"
fi

# Derive workspace from session
case "$SESSION" in
    cofoundy) WORKSPACE="2" ;;
    bilio)    WORKSPACE="3" ;;
    personal|per|dotfiles) WORKSPACE="4" ;;
    notes)    WORKSPACE="9" ;;
    standalone) WORKSPACE="5" ;;
    *)        WORKSPACE="" ;;
esac

# Create queue entry file (non-blocking)
QUEUE_FILE="${QUEUE_DIR}/${TIMESTAMP}_${SESSION}_${WINDOW}_${EVENT_TYPE}"
cat > "$QUEUE_FILE" 2>/dev/null << EOF || true
{
  "timestamp": $TIMESTAMP,
  "session": "$SESSION",
  "window": "$WINDOW",
  "window_index": "$WINDOW_INDEX",
  "pane_id": "$PANE_ID",
  "event_type": "$EVENT_TYPE",
  "workspace": "$WORKSPACE",
  "cwd": "$PWD"
}
EOF

# Build announcement
if [[ -n "${TMUX:-}" ]]; then
    ANNOUNCEMENT="${SESSION} ${WINDOW_INDEX} ${WINDOW}"
else
    ANNOUNCEMENT="${WINDOW}"
fi

# Play sound (fire and forget, fully detached)
if [[ "$EVENT_TYPE" == "question" ]]; then
    (afplay /System/Library/Sounds/Glass.aiff 2>/dev/null &)
    ANNOUNCEMENT="question ${ANNOUNCEMENT}"
else
    (afplay /System/Library/Sounds/Funk.aiff 2>/dev/null &)
    ANNOUNCEMENT="${ANNOUNCEMENT} done"
fi

# Voice announcement - fully detached with nohup, won't block script
# Uses timeout to prevent hanging
(
    nohup bash -c "
        TEMP_AUDIO=\$(mktemp /tmp/claude-notify-XXXXXX.aiff 2>/dev/null) || exit 0
        timeout 5 say -v Samantha -r 225 -o \"\$TEMP_AUDIO\" '$ANNOUNCEMENT' 2>/dev/null || exit 0
        timeout 3 afplay --volume 0.3 \"\$TEMP_AUDIO\" 2>/dev/null || true
        rm -f \"\$TEMP_AUDIO\" 2>/dev/null || true
    " >/dev/null 2>&1 &
) &
disown 2>/dev/null || true

# Set tmux window option (with timeout)
if [[ -n "${TMUX:-}" ]]; then
    TARGET="${SESSION}:${WINDOW_INDEX}"
    if [[ "$EVENT_TYPE" == "question" ]]; then
        timeout 1 tmux set-option -t "$TARGET" -w @claude_pending "q" 2>/dev/null || true
    else
        timeout 1 tmux set-option -t "$TARGET" -w @claude_pending "s" 2>/dev/null || true
    fi
    timeout 1 tmux refresh-client -S 2>/dev/null || true
fi

# Trigger SketchyBar - fully detached with timeout
(nohup timeout 2 sketchybar --trigger claude_pending_change >/dev/null 2>&1 &) &
disown 2>/dev/null || true

# Exit immediately - don't wait for background jobs
exit 0
