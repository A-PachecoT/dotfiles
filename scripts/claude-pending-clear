#!/bin/bash
# Clear pending Claude events
# Usage:
#   claude-pending-clear              # Clear for current tmux window
#   claude-pending-clear <session> <window>  # Clear specific
#   claude-pending-clear --all        # Clear all pending
#   claude-pending-clear --file <path>       # Clear specific file

set -euo pipefail

QUEUE_DIR="$HOME/.claude-pending"
LOCK_FILE="$QUEUE_DIR/.clear.lock"

# Ensure queue exists
mkdir -p "$QUEUE_DIR"

# For 'current' mode: use flock to prevent concurrent instances piling up
if [[ "${1:-current}" == "current" ]]; then
    exec 9>"$LOCK_FILE"
    if ! flock -n 9; then
        exit 0  # Another instance is running, skip
    fi
fi

# Function to trigger SketchyBar refresh
trigger_sketchybar() {
    sketchybar --trigger claude_pending_change 2>/dev/null &
}

case "${1:-current}" in
    --all)
        # Clear all pending
        rm -f "$QUEUE_DIR"/*_*_*_* 2>/dev/null || true
        echo "Cleared all pending"
        trigger_sketchybar
        ;;
    --file)
        # Clear specific file
        if [[ -n "${2:-}" && -f "$2" ]]; then
            rm -f "$2"
            echo "Cleared: $(basename "$2")"
            trigger_sketchybar
        fi
        ;;
    current)
        # Clear for current tmux window (by session + window INDEX, not name)
        if [[ -n "${TMUX:-}" ]]; then
            SESSION=$(tmux display-message -p '#S')
            WINDOW_INDEX=$(tmux display-message -p '#I')
        else
            exit 0  # Silent exit if not in tmux
        fi
        # Find and remove files matching session + window_index
        # Use grep instead of jq for speed (avoids spawning subprocess per file)
        CLEARED=0
        for f in "$QUEUE_DIR"/*_*_*_*; do
            [[ -f "$f" ]] || continue
            if grep -q "\"session\": \"$SESSION\"" "$f" 2>/dev/null &&
               grep -q "\"window_index\": \"$WINDOW_INDEX\"" "$f" 2>/dev/null; then
                rm -f "$f"
                ((CLEARED++))
            fi
        done
        if [[ $CLEARED -gt 0 ]]; then
            tmux refresh-client -S 2>/dev/null || true
            trigger_sketchybar
        fi
        ;;
    *)
        # Clear specific session:window
        SESSION="$1"
        WINDOW="${2:-}"
        if [[ -z "$WINDOW" && "$SESSION" == *":"* ]]; then
            # Handle session:window format
            WINDOW="${SESSION#*:}"
            SESSION="${SESSION%%:*}"
        fi
        if [[ -z "$WINDOW" ]]; then
            echo "Usage: claude-pending-clear <session> <window>"
            exit 1
        fi
        PATTERN="${QUEUE_DIR}/*_${SESSION}_${WINDOW}_*"
        CLEARED=0
        for f in $PATTERN; do
            if [[ -f "$f" ]]; then
                rm -f "$f"
                ((CLEARED++))
            fi
        done
        echo "Cleared $CLEARED pending for ${SESSION}:${WINDOW}"
        [[ $CLEARED -gt 0 ]] && trigger_sketchybar
        ;;
esac
