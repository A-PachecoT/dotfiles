#!/bin/bash
# HyDE-inspired SketchyBar Configuration
# Using official AeroSpace integration

PLUGIN_DIR="$CONFIG_DIR/plugins"
source "$HOME/.config/sketchybar/themes/tokyo-night"

##### Bar Appearance #####
sketchybar --bar position=top height=32 blur_radius=50 color=$BAR_COLOR \
                 border_width=0 margin=10 corner_radius=12

##### Default Item Properties #####
default=(
  padding_left=8
  padding_right=8
  icon.font="MonoLisaNerdFont-Regular:Regular:14.0"
  label.font="MonoLisaNerdFont-Regular:Regular:12.0" 
  icon.color=$WHITE
  label.color=$WHITE
  icon.padding_left=4
  icon.padding_right=4
  label.padding_left=4
  label.padding_right=4
  background.height=22
  background.corner_radius=8
)
sketchybar --default "${default[@]}"

##### AeroSpace Integration #####
# Add the aerospace workspace change event
sketchybar --add event aerospace_workspace_change

# Add workspace manager that rebuilds workspace list on changes (Hyprland-style)
sketchybar --add item workspace_manager left \
           --set workspace_manager drawing=off \
           script="$PLUGIN_DIR/aerospace_workspaces.sh" \
           --subscribe workspace_manager aerospace_workspace_change

# Add current app first (will be repositioned after workspaces)
sketchybar --add item current_app left \
           --set current_app icon.drawing=off script="$PLUGIN_DIR/front_app.sh" \
           --subscribe current_app front_app_switched

# Initialize workspaces on startup
"$PLUGIN_DIR/aerospace_workspaces.sh"

##### Right Side Items #####
# Work session indicator (moon icon when active)
sketchybar --add item work_session right \
           --set work_session script="$PLUGIN_DIR/work_session.sh" \
                update_freq=60 \
                drawing=off \
                position=right

sketchybar --add item clock right \
           --set clock icon="" update_freq=30 script="$PLUGIN_DIR/clock.sh"

# Microphone status indicator
sketchybar --add event mic_toggle \
           --add item mic_status right \
           --set mic_status script="$PLUGIN_DIR/mic_status.sh" \
                update_freq=0 \
                icon.font="Hack Nerd Font:Regular:16.0" \
                click_script="hs -c 'hs.eventtap.keyStroke({\"cmd\", \"shift\"}, \"m\")'" \
                --subscribe mic_status mic_toggle

# Initialize mic status on startup
"$PLUGIN_DIR/mic_status.sh"

# Nerd Font emoji test with Hack Nerd Font
# sketchybar --add item nerd_font_test right \
#            --set nerd_font_test icon="󰊠 󰊢 󰊤 󰊦 󰊨" \
#                 label="NerdFont Test" \
#                 icon.font="Hack Nerd Font:Regular:18.0" \
#                 label.font="MonoLisa Nerd Font:Regular:10.0"

##### Initialize #####
sketchybar --update