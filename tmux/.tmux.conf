# =============================================================================
# TMUX - Power User Config
# Layout: CC (40%) + Editor (60%) with vim navigation
# =============================================================================

# -----------------------------------------------------------------------------
# GENERAL
# -----------------------------------------------------------------------------
set -g default-terminal "tmux-256color"
set -ag terminal-overrides ",xterm-256color:RGB"
set -g allow-passthrough on  # Required for yazi image preview
set -g mouse on
set -g base-index 1
setw -g pane-base-index 1
set -g renumber-windows on
set -g automatic-rename on
set -g automatic-rename-format '#{b:pane_current_path}'
set -g history-limit 50000
set -s escape-time 0
set -g focus-events on

# Terminal title (for AeroSpace window routing)
set -g set-titles on
set -g set-titles-string "#{session_name}"

# -----------------------------------------------------------------------------
# PREFIX: Ctrl+b (default - CC doesn't capture this)
# -----------------------------------------------------------------------------
set -g prefix C-b
bind C-b send-prefix

# -----------------------------------------------------------------------------
# PANE NAVIGATION (Ctrl+Arrow - NO PREFIX NEEDED)
# -----------------------------------------------------------------------------
bind -n C-Left select-pane -L
bind -n C-Down select-pane -D
bind -n C-Up select-pane -U
bind -n C-Right select-pane -R

# Also with prefix + hjkl
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# -----------------------------------------------------------------------------
# PANE MANAGEMENT (with prefix)
# -----------------------------------------------------------------------------
bind d run-shell "/opt/homebrew/bin/bash ~/dotfiles/scripts/tmux-smart-split-h"
bind D run-shell "/opt/homebrew/bin/bash ~/dotfiles/scripts/tmux-smart-split-v"
bind x run-shell "/opt/homebrew/bin/bash ~/dotfiles/scripts/tmux-kill-pane"
bind z resize-pane -Z
bind q detach-client

# Resize (prefix + H/J/K/L)
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# -----------------------------------------------------------------------------
# WINDOW/TAB MANAGEMENT
# -----------------------------------------------------------------------------
bind c new-window -c "#{pane_current_path}"
bind w run-shell "~/dotfiles/scripts/tmux-kill-window"
bind n next-window
bind p previous-window
bind 1 select-window -t 1
bind 2 select-window -t 2
bind 3 select-window -t 3
bind 4 select-window -t 4
bind 5 select-window -t 5

# -----------------------------------------------------------------------------
# SESSION MANAGEMENT
# -----------------------------------------------------------------------------
bind s choose-tree -sZ
bind S new-session
bind r source-file ~/.tmux.conf \; display "Reloaded!"

# -----------------------------------------------------------------------------
# COPY MODE (vim style)
# -----------------------------------------------------------------------------
setw -g mode-keys vi
bind Enter copy-mode
bind -T copy-mode-vi v send -X begin-selection
bind -T copy-mode-vi y send -X copy-pipe-and-cancel "pbcopy"
bind -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel "pbcopy"

# Quick URL open: prefix+u enters copy-mode and searches for URL
bind u copy-mode \; send-keys "?http" Enter

# Quick file open: prefix+f searches for file paths (like src/file.ts:42)
bind f copy-mode \; send-keys "?[a-zA-Z0-9_.//-]\\+\\.[a-zA-Z]\\+:" Enter

# Open selected file in yazi: select path in copy-mode, press 'g' (go to file)
bind -T copy-mode-vi g send-keys -X copy-pipe-and-cancel "xargs ~/dotfiles/scripts/open-in-yazi.sh"

# -----------------------------------------------------------------------------
# TOKYO NIGHT THEME
# -----------------------------------------------------------------------------
set -g status-position top
set -g status-style "bg=#1a1b26,fg=#c0caf5"
set -g status-left-length 50
set -g status-left "#[fg=#7aa2f7,bold]  #S #[fg=#3b4261]│"
set -g status-right-length 50
set -g status-right "#[fg=#3b4261]│#[fg=#9ece6a] %H:%M #[fg=#3b4261]│#[fg=#bb9af7] %d-%b "
# Window status with Claude pending badges
# #{?@claude_pending,...} shows badge when option is set
# "q" = question (󰂞), "s" = stop (●)
# #{?#{==:#{@claude_active},a},...} shows amber when Claude is working
setw -g window-status-format "#{?#{==:#{@claude_active},a},#[fg=#e0af68],#[fg=#3b4261]} #I:#W#{?#{==:#{@claude_pending},q},#[fg=#f7768e]󰂞,#{?#{==:#{@claude_pending},s},#[fg=#9ece6a]●,}} "
setw -g window-status-current-format "#[bold]#{?#{==:#{@claude_active},a},#[fg=#e0af68],#[fg=#7aa2f7]} #I:#W#{?#{==:#{@claude_pending},q},#[fg=#f7768e]󰂞,#{?#{==:#{@claude_pending},s},#[fg=#9ece6a]●,}} "
set -g pane-border-style "fg=#3b4261"
set -g pane-active-border-style "fg=#7aa2f7"
set -g message-style "bg=#1a1b26,fg=#7aa2f7"
setw -g mode-style "bg=#33467c,fg=#c0caf5"

# -----------------------------------------------------------------------------
# CLAUDE PENDING NAVIGATION
# Clear badge when user SWITCHES windows (not on every pane focus)
# -----------------------------------------------------------------------------
set-hook -g after-select-window 'run-shell -b "~/dotfiles/scripts/claude-pending-clear >/dev/null 2>&1; tmux set-option -w @claude_pending \"\" 2>/dev/null; tmux set-option -w @claude_active \"\" 2>/dev/null; true"'

# Jump to oldest pending Claude (prefix + C)
bind C run-shell "~/dotfiles/scripts/claude-jump"

# Open fzf picker for pending Claudes (prefix + Alt+c)
# After popup closes, read target from temp file and navigate
# Format: session:window_index:workspace
bind M-c run-shell '\
    rm -f /tmp/claude-picker-target; \
    tmux display-popup -E -w 60% -h 50% "~/dotfiles/scripts/claude-picker-fzf"; \
    if [ -f /tmp/claude-picker-target ]; then \
        TARGET=$(cat /tmp/claude-picker-target); \
        SESSION=$(echo $TARGET | cut -d: -f1); \
        WIN_IDX=$(echo $TARGET | cut -d: -f2); \
        WORKSPACE=$(echo $TARGET | cut -d: -f3); \
        [ -n "$WORKSPACE" ] && aerospace workspace $WORKSPACE 2>/dev/null; \
        tmux switch-client -t "$SESSION:$WIN_IDX" 2>/dev/null || tmux switch-client -t "$SESSION" 2>/dev/null; \
        rm -f /tmp/claude-picker-target; \
    fi \
'

# -----------------------------------------------------------------------------
# PLUGINS
# -----------------------------------------------------------------------------
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @plugin 'tmux-plugins/tmux-open'  # Open URLs: select in copy-mode, press 'o'
set -g @plugin 'Morantron/tmux-fingers'  # Quick select: prefix+F shows hints

# tmux-open: 'o' opens URLs, 'f' opens files in yazi
set -g @open 'o'
set -g @open-F 'https://www.google.com/search?q='
set -g @open-editor 'C-o'

# tmux-fingers config: Cmd+f (via Ghostty) shows hints, press letter to smart-open
# Note: May temporarily break scroll in TUI apps like Claude Code
set -g @fingers-key F
set -g @fingers-main-action '$HOME/dotfiles/scripts/smart-open.sh'
set -g @fingers-shift-action ':paste:'

# Hop patterns: extend default matching for paths with spaces
# Pattern 0: Extension-anchored paths (allows spaces between path start and extension)
# Matches: /01. Personal/file.pdf, ~/Documents/my file.md, font-test.html
set -g @fingers-pattern-0 '([~./][^:*?"<>|\r\n]+?|[a-zA-Z0-9_][a-zA-Z0-9_.-]*)\.(pdf|md|txt|png|jpg|jpeg|gif|docx|xlsx|pptx|csv|json|yaml|yml|toml|ts|tsx|js|jsx|py|rs|go|rb|sh|lua|html|css|sql|swift|kt|java|c|cpp|h|hpp)'

# Pattern 1: Quoted paths (any path in single or double quotes)
# Matches: "path/with spaces/file.txt", '/some/other path'
set -g @fingers-pattern-1 '"[^"\r\n]+"'
set -g @fingers-pattern-2 ''"'"'[^'"'"'\r\n]+'"'"''

set -g @resurrect-capture-pane-contents 'on'
set -g @resurrect-processes 'yazi'
set -g @continuum-restore 'on'
set -g @continuum-save-interval '10'

# Auto-install TPM
if "test ! -d ~/.tmux/plugins/tpm" \
   "run 'git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm'"

run '~/.tmux/plugins/tpm/tpm'
